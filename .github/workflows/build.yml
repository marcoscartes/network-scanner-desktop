name: Build and Release

on:
  push:
    tags:
      - 'v*'

permissions:
  contents: write

jobs:
  build:
    name: Build and Release
    runs-on: windows-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.21'
          check-latest: true

      - name: Get dependencies
        run: go mod tidy

      - name: Build Windows
        run: |
          $env:GOOS='windows'
          $env:GOARCH='amd64'
          go build -ldflags="-H windowsgui -s -w" -o scanner-desktop-windows-amd64.exe cmd/desktop/main.go

      - name: Build Linux AMD64
        run: |
          $env:GOOS='linux'
          $env:GOARCH='amd64'
          go build -ldflags="-s -w" -o scanner-desktop-linux-amd64 cmd/desktop/main.go

      - name: Build Linux ARM64
        run: |
          $env:GOOS='linux'
          $env:GOARCH='arm64'
          go build -ldflags="-s -w" -o scanner-desktop-linux-arm64 cmd/desktop/main.go

      - name: Build macOS AMD64
        run: |
          $env:GOOS='darwin'
          $env:GOARCH='amd64'
          go build -ldflags="-s -w" -o scanner-desktop-macos-amd64 cmd/desktop/main.go

      - name: Build macOS ARM64
        run: |
          $env:GOOS='darwin'
          $env:GOARCH='arm64'
          go build -ldflags="-s -w" -o scanner-desktop-macos-arm64 cmd/desktop/main.go

      # OPTIONAL: Code Signing Step (Uncomment and configure secrets when you have a certificate)
      # - name: Sign Windows Binary
      #   uses: skuehl/sign-action@v1
      #   if: startsWith(github.ref, 'refs/tags/')
      #   with:
      #     certificate: ${{ secrets.WINDOW_PFX_BASE64 }}
      #     password: ${{ secrets.WINDOW_PFX_PASSWORD }}
      #     cert-extension: pfx
      #     files: scanner-desktop-windows-amd64.exe

      - name: Create Release
        uses: softprops/action-gh-release@v2
        if: startsWith(github.ref, 'refs/tags/')
        with:
          files: |
            scanner-desktop-windows-amd64.exe
            scanner-desktop-linux-amd64
            scanner-desktop-linux-arm64
            scanner-desktop-macos-amd64
            scanner-desktop-macos-arm64
          draft: false
          prerelease: false
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
